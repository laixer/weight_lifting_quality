---
title: "Weight Lifting Quality Assesment"
output: html_document
---

```{r}
library(caret)
library(plyr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(parallel)
library(reshape2)
library(doMC)
registerDoMC(cores = 4)
```

```{r}
training <- read.csv("pml-training.csv")
testing <- read.csv("pml-testing.csv")
```

```{r}
carlitos_good_lifts <- training %>% 
  filter(user_name == "carlitos" & classe == "A") %>%
  mutate(raw_timestamp = ((raw_timestamp_part_1 - min(raw_timestamp_part_1)) * 1000000 + raw_timestamp_part_2) / 1000000.0)

belt_features <- c("roll_belt", "pitch_belt", "yaw_belt", "total_accel_belt",
                   "gyros_belt_x", "gyros_belt_y", "gyros_belt_z", 
                   "accel_belt_x", "accel_belt_y", "accel_belt_z", 
                   "magnet_belt_x", "magnet_belt_y", "magnet_belt_z")
arm_features <- c("roll_arm", "pitch_arm", "yaw_arm", "total_accel_arm", 
                  "gyros_arm_x", "gyros_arm_y", "gyros_arm_z", "accel_arm_x",
                  "accel_arm_y", "accel_arm_z", "magnet_arm_x", "magnet_arm_y",
                  "magnet_arm_z")
dumbbell_features <- c("roll_dumbbell", "pitch_dumbbell", "yaw_dumbbell",
                       "total_accel_dumbbell", "gyros_dumbbell_x", 
                       "gyros_dumbbell_y", "gyros_dumbbell_z", 
                       "accel_dumbbell_x", "accel_dumbbell_y", 
                       "accel_dumbbell_z", "magnet_dumbbell_x", 
                       "magnet_dumbbell_y", "magnet_dumbbell_z")
forearm_features <- c("roll_forearm", "pitch_forearm", "yaw_forearm",
                      "total_accel_forearm", "gyros_forearm_x", 
                      "gyros_forearm_y", "gyros_forearm_z", "accel_forearm_x",
                      "accel_forearm_y", "accel_forearm_z", "magnet_forearm_x",
                      "magnet_forearm_y", "magnet_forearm_z")

carlitos_good_lifts.narrow <- melt(carlitos_good_lifts, 
                                   id.vars = c("raw_timestamp"), 
                                   measure.vars = c(belt_features,
                                                    arm_features,
                                                    dumbbell_features,
                                                    forearm_features))
carlitos_good_lifts.narrow$source <- 
  ifelse(carlitos_good_lifts.narrow$variable %in% belt_features, "belt", 
         ifelse(carlitos_good_lifts.narrow$variable %in% arm_features, "arm",
                ifelse(carlitos_good_lifts.narrow$variable %in% dumbbell_features, "dumbbell",
                       ifelse(carlitos_good_lifts.narrow$variable %in% forearm_features, "forearm", 
                              "UNKNOWN"))))

carlitos_good_lifts.narrow$variable <- 
  gsub("_(belt|arm|dumbbell|forearm)", "", carlitos_good_lifts.narrow$variable)
```


```{r}
ggplot(carlitos_good_lifts.narrow,  aes(raw_timestamp, value, color=variable)) + 
  facet_wrap(~source, ncol = 1) +
  geom_line() + 
  scale_x_continuous(breaks = 1:40)
```

```{r}
extract_features <- function(df) {
  return(select(df, one_of("classe", "user_name", belt_features, arm_features, dumbbell_features, forearm_features)))
}

# TODO(laixer): Does the data need to be shuffled?
fit_control_rf <- trainControl(method = "cv", number = 10, verboseIter = TRUE)
set.seed(94610348)
fit_rf <- train(classe ~ .,
                data = extract_features(training),
                method = "rf",
                trControl = fit_control_rf)

# all basic features
#   mtry  Accuracy   Kappa      Accuracy SD  Kappa SD   
#    2    0.9951583  0.9938754  0.001447289  0.001831010
#   27    0.9950565  0.9937465  0.002094801  0.002650455
#   52    0.9893996  0.9865899  0.002694160  0.003408644
#
# all basic features + user_name
#  mtry  Accuracy   Kappa      Accuracy SD  Kappa SD   
#   2    0.9945976  0.9931661  0.001426535  0.001804788
#  29    0.9949036  0.9935531  0.002461376  0.003114203
#  57    0.9895016  0.9867185  0.002992332  0.003786093

```

```{r}
fit_control_nn <- trainControl(method = "cv", number = 10, verboseIter = TRUE)
tune_grid_nn <- expand.grid(.decay = c(0), .size = c(200))

set.seed(10482349)
fit_nn <- train(classe ~ ., 
                data = extract_features(training), 
                method = "nnet", 
                trControl = fit_control_nn, 
                trace = FALSE, 
                tuneGrid = tune_grid_nn,
                MaxNWts = 10000,
                preProcess = c("center", "scale", "pca"))
# all basic features + user_name
#   size  decay  Accuracy   Kappa      Accuracy SD  Kappa SD  
#   1     0e+00  0.3649976  0.1738136  0.02360002   0.02413697
#   1     1e-04  0.3494004  0.1626049  0.01864389   0.01251200
#   1     1e-01  0.3611257  0.1774195  0.02013515   0.01393788
#   3     0e+00  0.5228688  0.3947108  0.04022309   0.05364542
#   3     1e-04  0.4992878  0.3660884  0.02990224   0.03457736
#   3     1e-01  0.5129959  0.3828822  0.03287314   0.04498382
#   5     0e+00  0.5794025  0.4665667  0.01818793   0.02559333
#   5     1e-04  0.5822578  0.4715057  0.02330148   0.03035747
#   5     1e-01  0.5939829  0.4842045  0.02685523   0.03507407
# all basic features + user_name
#   size  Accuracy   Kappa      Accuracy SD  Kappa SD  
#    5    0.5804702  0.4677960  0.019511354  0.02534310
#   15    0.7915130  0.7362199  0.022973729  0.02918866
#   30    0.8874728  0.8576602  0.009834545  0.01244672
```

```{r}
fit_control_svm <- trainControl(method = "cv", number = 10, verboseIter = TRUE)
tune_grid_svm <- expand.grid(.sigma = 0.01263598, .C = c(1, 10, 100))

set.seed(10482349)
fit_svm <- train(classe ~ ., 
                data = extract_features(training), 
                method = "svmRadial", 
                trControl = fit_control_svm, 
                tuneGrid = tune_grid_svm,
                trace = FALSE, 
                preProcess = c("center", "scale"))
```

```{r}
predict_rf <- predict(fit_rf, newdata=training)
predict_nn <- predict(fit_nn, newdata=training)
predict_svm <- predict(fit_svm, newdata=training)
combined_training <- data.frame(classe=training$classe, 
                                classe_rf=predict_rf,
                                classe_nn=predict_nn,
                                classe_svm=predict_svm)
combined_fit <- train(classe ~ ., data = combined_training, method = "rf")

```

```{r}
testing$classe = "U"
test_predict_rf <- predict(fit_rf, newdata=testing)
test_predict_nn <- predict(fit_nn, newdata=testing)
test_predict_svm <- predict(fit_svm, newdata=testing)
combined_test <- data.frame(classe_rf=test_predict_rf,
                            classe_nn=test_predict_nn,
                            classe_svm=test_predict_svm)
predict_final <- predict(combined_fit, newdata=combined_test)
```

```{r}
pml_write_files = function(x){
   n = length(x)   
   for(i in 1:n){
     filename = paste0("problem_id_",i,".txt")
     write.table(x[i],file=filename,quote=FALSE,row.names=FALSE,col.names=FALSE)
   }
}
 
pml_write_files(predict_final)
```